# ADR 0004: データベースはTiDB（ベクトル検索）に統一する

## ステータス
- 採用

## コンテキスト
- Phase分割（SQLite/FTS5 → PostgreSQL/pgvector）を前提にしていたが、さくらのクラウドのエンハンスドDBがTiDBであり、運用面・提供形態の都合からTiDBを利用できる。
- 埋め込み検索を最初から使える環境があり、検索精度と運用統合を優先したい。
- 検索方式の差し替えを可能にするため、`retrieve()` インターフェースによる抽象化は維持する。

## 決定
- データベースはTiDBに統一し、ベクトル検索を標準とする。
- Phase 1/Phase 2の段階分けは廃止する。
- 取得処理は `retrieve()` インターフェースで抽象化し、実装差し替え可能な構造は維持する。
- 取り込みは「PDFテキスト抽出 → OCRフォールバック → チャンク化 → embedding化 → TiDB登録」の順で行う。
- 検索は「質問文のembedding化 → TiDBベクトル検索 → 候補チャンク取得 → 根拠付き回答」を基本フローとする。
- embeddingモデル/次元、距離関数、インデックス方式は別途選定し、実装前に明記する。

## 影響・結果
- SQLite/FTS5やPostgreSQL/pgvectorは採用しない。
- 取り込み時にチャンクとベクトルをTiDBへ登録する前提で実装する。
- 検索品質はベクトル検索を中心に評価し、必要に応じて追加方針を検討する。
